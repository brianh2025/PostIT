<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A4 列印模板 (含下拉選單)</title>
    <!-- 引入 Tailwind CSS 以快速美化非列印元素 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Google Fonts - Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* 淺灰色背景 */
        }

        /* 針對列印的樣式 */
        @media print {
            /* 隱藏所有不需要列印的元素 */
            .no-print {
                display: none !important;
            }
            .print-only-name {
                display: inline-block !important;
            }

            /* 確保列印頁面沒有多餘的邊距 */
            @page {
                size: A4;
                margin: 0;
            }

            body {
                margin: 0;
                padding: 0;
                background-color: #fff; /* 列印時背景為白色 */
            }
            
            /* 列印時，頁面容器填滿整個頁面 */
            .page-container {
                margin: 0;
                padding: 0;
                box-shadow: none;
                border: none;
            }
            
            /* 列印時移除格子的外框和 placeholder */
            .grid-cell {
                color: #000 !important;
            }
            .grid-cell:focus-within {
                outline: none !important;
            }
        }

        /* A4 頁面容器的樣式 (用於預覽) */
        /* A4 尺寸: 210mm x 297mm */
        .page-container {
            width: 210mm;
            height: 297mm;
            background-color: white;
            margin: 2rem auto; /* 在螢幕上置中顯示 */
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            box-sizing: border-box; /* 確保 padding 不會增加寬高 */
            display: flex;
            flex-direction: column;
            align-items: center; /* 水平置中網格 */
            padding-top: 24pt;   /* 上邊距 2cm */
            padding-bottom: 24pt;/* 下邊距 2cm */
        }

        /* 網格容器 */
        .grid-container {
            display: grid;
            /* 4 欄，每欄 4.5cm */
            grid-template-columns: repeat(4, 4.5cm);
            /* 5 列，每列 5cm */
            grid-template-rows: repeat(5, 5cm);
            gap: 0; /* 儲存格之間沒有間距 */
            border-left: 1px solid #ccc; /* 加上左邊框和上邊框以形成完整網格 */
            border-top: 1px solid #ccc;
        }

        /* 網格中的儲存格 */
        .grid-cell {
            width: 100%; /* 寬度由 grid 控制 */
            height: 5cm;
            border-right: 1px solid #ccc; /* 儲存格的右邊框和下邊框 */
            border-bottom: 1px solid #ccc;
            box-sizing: border-box; /* 確保邊框不會增加儲存格大小 */
            padding: 8px; /* 增加內邊距 */
            overflow: hidden; /* 防止內容溢出 */
            color: #1f2937; /* 輸入的文字顏色 */
            font-size: 14px;
            display: flex;
            flex-direction: column;
        }
        
        /* 當點擊儲存格進行編輯時，顯示藍色外框 */
        .grid-cell:focus-within {
            outline: 2px solid #3b82f6;
            outline-offset: -2px; /* 讓外框在格子內部 */
        }
        
        /* 合併後的儲存格樣式 (僅作為標記) */
        .merged-cell {
           /* 實際的合併樣式由 JavaScript 動態設定 */
        }

        .cell-header {
            flex-shrink: 0;
            margin-bottom: 4px;
        }

        .personnel-select {
            border: none;
            border-bottom: 1px solid #000;
            background: transparent;
            padding: 0 4px;
            font-size: 14px;
        }
        .personnel-select:focus {
            outline: none;
        }

        .print-only-name {
            display: none; /* 螢幕上隱藏 */
            min-width: 100px; /* 給予足夠寬度 */
            border-bottom: 1px solid #000;
            text-align: center;
            padding: 0 4px;
        }

        .editable-content {
            flex-grow: 1;
            word-wrap: break-word;
        }
        .editable-content:focus {
            outline: none;
        }
        .editable-content:empty::before {
            content: '在此輸入內容...';
            color: #9ca3af;
            pointer-events: none;
        }

    </style>
</head>
<body class="bg-gray-100">

    <!-- 頁面頂部的控制項 (非列印區域) -->
    <header class="no-print p-4 bg-white shadow-md sticky top-0">
        <div class="container mx-auto flex justify-between items-center flex-wrap gap-4">
            <div>
                <h1 class="text-xl font-bold text-gray-800">A4 列印模板 (含下拉選單)</h1>
                <p class="text-sm text-gray-500">4 欄 x 5 列，每格 4.5x5cm，上下邊距 2cm</p>
            </div>
            
            <!-- 合併控制項 -->
            <div class="flex items-center gap-2 flex-wrap">
                <label for="row-to-merge" class="text-sm font-medium text-gray-700">列號:</label>
                <input type="number" id="row-to-merge" min="1" max="5" class="w-20 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="1-5">
                <label for="cols-to-merge" class="text-sm font-medium text-gray-700">欄號:</label>
                <input type="text" id="cols-to-merge" class="w-28 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="例: 1-3 或 2,3">
                <button id="merge-btn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow transition-transform transform hover:scale-105">合併</button>
                <button id="reset-btn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow transition-transform transform hover:scale-105">重設版面</button>
                <span id="message-box" class="text-red-500 text-sm font-semibold ml-2"></span>
            </div>

            <button onclick="window.print()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow transition-transform transform hover:scale-105">
                🖨️ 列印此頁面
            </button>
        </div>
    </header>

    <!-- A4 頁面預覽容器 -->
    <main>
        <div id="page" class="page-container">
            <div id="grid" class="grid-container">
                <!-- JavaScript 會自動生成 20 個可編輯的儲存格 -->
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const gridContainer = document.getElementById('grid');
            const mergeBtn = document.getElementById('merge-btn');
            const resetBtn = document.getElementById('reset-btn');
            const rowInput = document.getElementById('row-to-merge');
            const colInput = document.getElementById('cols-to-merge');
            const messageBox = document.getElementById('message-box');
            const totalCells = 20;
            const cols = 4;

            // *** 在這裡修改或新增人員名單 ***
            const personnel = ["所長", "吳淵文", "張皓翔", "林義傑", "陳煌奇", "楊立羚", "陳彥宏", "莊美玲", "梁耀元"];

            // 顯示訊息並在幾秒後淡出
            function showMessage(text, isError = true) {
                messageBox.textContent = text;
                messageBox.className = isError ? 'text-red-500 text-sm font-semibold ml-2' : 'text-green-500 text-sm font-semibold ml-2';
                setTimeout(() => {
                    messageBox.textContent = '';
                }, 3000);
            }

            // 產生初始網格
            function createGrid() {
                gridContainer.innerHTML = ''; // 清空現有網格
                for (let i = 1; i <= totalCells; i++) {
                    const cell = document.createElement('div');
                    cell.classList.add('grid-cell');
                    cell.id = `cell-${i}`;

                    // --- 建立格子內的結構 ---
                    const headerDiv = document.createElement('div');
                    headerDiv.classList.add('cell-header');
                    
                    const toSpan = document.createElement('span');
                    toSpan.textContent = 'To：';

                    // 建立下拉選單 (螢幕上顯示)
                    const selectEl = document.createElement('select');
                    selectEl.classList.add('personnel-select', 'no-print');
                    
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = '請選擇';
                    selectEl.appendChild(defaultOption);

                    personnel.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        selectEl.appendChild(option);
                    });

                    // 建立列印時顯示的姓名 Span
                    const printNameSpan = document.createElement('span');
                    printNameSpan.classList.add('print-only-name');
                    printNameSpan.textContent = ' '; // 預設為空白，讓底線顯示

                    // 建立可編輯內容區域
                    const editableDiv = document.createElement('div');
                    editableDiv.classList.add('editable-content');
                    editableDiv.contentEditable = 'true';

                    // 監聽下拉選單的變化，更新列印用的 Span
                    selectEl.addEventListener('change', (e) => {
                        const selectedValue = e.target.value;
                        printNameSpan.textContent = selectedValue || ' '; // 如果沒選，就顯示空白
                    });

                    headerDiv.appendChild(toSpan);
                    headerDiv.appendChild(selectEl);
                    headerDiv.appendChild(printNameSpan);
                    cell.appendChild(headerDiv);
                    cell.appendChild(editableDiv);
                    
                    gridContainer.appendChild(cell);
                }
            }

            // 解析並驗證欄位輸入字串
            function parseAndValidateColumns(str) {
                const columns = new Set();
                if (!str || !str.trim()) return null;

                const parts = str.split(',');
                for (const part of parts) {
                    const trimmedPart = part.trim();
                    if (trimmedPart.includes('-')) {
                        const [start, end] = trimmedPart.split('-').map(Number);
                        if (isNaN(start) || isNaN(end) || start < 1 || end > cols || start >= end) return null;
                        for (let i = start; i <= end; i++) columns.add(i);
                    } else {
                        const num = Number(trimmedPart);
                        if (isNaN(num) || num < 1 || num > cols) return null;
                        columns.add(num);
                    }
                }
                return Array.from(columns).sort((a, b) => a - b);
            }

            // 合併指定列的指定欄位
            function mergeRow() {
                const row = parseInt(rowInput.value);
                if (isNaN(row) || row < 1 || row > 5) {
                    showMessage('請輸入有效的列號 (1-5)');
                    return;
                }

                const colStr = colInput.value;
                const parsedCols = parseAndValidateColumns(colStr);

                if (!parsedCols || parsedCols.length === 0) {
                    showMessage('請輸入有效的欄號 (例: 1-3 或 2,3)');
                    return;
                }

                const isContiguous = parsedCols.length < 2 || (parsedCols[parsedCols.length - 1] - parsedCols[0] + 1 === parsedCols.length);
                if (!isContiguous) {
                    showMessage('合併失敗：僅能合併連續的欄位');
                    return;
                }
                
                const allCells = Array.from(gridContainer.children);
                const rowStartIndex = (row - 1) * cols;

                for (let i = 0; i < cols; i++) {
                    const cell = allCells[rowStartIndex + i];
                    if (cell) {
                        cell.style.display = '';
                        cell.style.gridColumn = '';
                        cell.classList.remove('merged-cell');
                    }
                }

                if (parsedCols.length > 1) {
                    const startCol = parsedCols[0];
                    const spanCount = parsedCols.length;
                    const startCellIndex = rowStartIndex + startCol - 1;
                    
                    const startCell = allCells[startCellIndex];
                    if (startCell) {
                        startCell.classList.add('merged-cell');
                        startCell.style.gridColumn = `span ${spanCount}`;

                        for (let i = 1; i < spanCount; i++) {
                            const cellToHide = allCells[startCellIndex + i];
                            if (cellToHide) cellToHide.style.display = 'none';
                        }
                    }
                }
                
                showMessage(`第 ${row} 列已更新`, false);
            }

            // 重設整個網格版面
            function resetGrid() {
                createGrid();
                showMessage('版面已重設', false);
            }

            // 綁定事件監聽器
            mergeBtn.addEventListener('click', mergeRow);
            resetBtn.addEventListener('click', resetGrid);

            // 初始載入
            createGrid();
        });
    </script>

</body>
</html>


